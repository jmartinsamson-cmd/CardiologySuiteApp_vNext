<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SVG Sanitizer Browser Test</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #333;
      border-bottom: 2px solid #dc2626;
      padding-bottom: 10px;
    }
    .test-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-case {
      margin: 15px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .test-case h3 {
      margin-top: 0;
      color: #555;
    }
    .result {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-family: monospace;
    }
    .result.pass {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    .result.fail {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
    .svg-container {
      display: flex;
      gap: 20px;
      margin: 10px 0;
    }
    .svg-box {
      padding: 10px;
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .svg-box svg {
      display: block;
      margin: 10px 0;
    }
    code {
      background: #f4f4f4;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.9em;
    }
    .console-output {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      margin: 10px 0;
    }
    .console-output .info { color: #4fc3f7; }
    .console-output .warn { color: #ffb74d; }
    .console-output .error { color: #e57373; }
    .summary {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 15px;
      margin: 20px 0;
    }
    button {
      background: #dc2626;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }
    button:hover {
      background: #b91c1c;
    }
  </style>
</head>
<body>
  <h1>üß™ SVG ViewBox Sanitizer - Browser Test Suite</h1>

  <div class="summary" id="summary">
    <strong>Status:</strong> Waiting for tests to run...
  </div>

  <div class="test-section">
    <h2>Manual Controls</h2>
    <button onclick="runAllTests()">Run All Tests</button>
    <button onclick="clearConsoleOutput()">Clear Console</button>
    <button onclick="injectBadSVG()">Inject Invalid SVG</button>
  </div>

  <div class="test-section">
    <h2>Console Output</h2>
    <div class="console-output" id="consoleOutput"></div>
  </div>

  <div id="testResults"></div>

  <!-- Load SVG Sanitizer -->
  <script src="../../src/utils/svgSanitizer.browser.js"></script>

  <script>
    // Capture console output
    const consoleOutput = document.getElementById('consoleOutput');
    const originalConsole = {
      log: console.log,
      info: console.info,
      warn: console.warn,
      error: console.error
    };

    function logToConsole(message, type = 'log') {
      const line = document.createElement('div');
      line.className = type;
      line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      consoleOutput.appendChild(line);
      consoleOutput.scrollTop = consoleOutput.scrollHeight;
      originalConsole[type](message);
    }

    console.log = (msg) => logToConsole(msg, 'log');
    console.info = (msg) => logToConsole(msg, 'info');
    console.warn = (msg) => logToConsole(msg, 'warn');
    console.error = (msg) => logToConsole(msg, 'error');

    function clearConsoleOutput() {
      consoleOutput.innerHTML = '';
      logToConsole('Console cleared', 'info');
    }

    // Test cases
    const tests = [
      {
        name: 'Test 1: Fix percentage in width',
        viewBoxBefore: '0 0 100% 4',
        viewBoxExpected: '0 0 100 4',
        description: 'Should convert 100% to 100'
      },
      {
        name: 'Test 2: Fix all percentages',
        viewBoxBefore: '0% 0% 100% 100%',
        viewBoxExpected: '0 0 100 100',
        description: 'Should convert all percentage values to numbers'
      },
      {
        name: 'Test 3: Preserve valid viewBox',
        viewBoxBefore: '0 0 24 24',
        viewBoxExpected: '0 0 24 24',
        description: 'Should not modify valid numeric viewBox'
      },
      {
        name: 'Test 4: Preserve decimals',
        viewBoxBefore: '0 0 23.5 24.8',
        viewBoxExpected: '0 0 23.5 24.8',
        description: 'Should preserve decimal values'
      },
      {
        name: 'Test 5: Preserve negative values',
        viewBoxBefore: '-10 -10 100 100',
        viewBoxExpected: '-10 -10 100 100',
        description: 'Should preserve negative values'
      }
    ];

    function createSVG(viewBox) {
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('viewBox', viewBox);
      svg.setAttribute('width', '100');
      svg.setAttribute('height', '100');
      svg.innerHTML = '<rect width="100%" height="100%" fill="#dc2626" />';
      return svg;
    }

    function runTest(test, index) {
      const testCase = document.createElement('div');
      testCase.className = 'test-case';
      testCase.innerHTML = `<h3>${test.name}</h3><p>${test.description}</p>`;

      // Create SVG before sanitization
      const svgBefore = createSVG(test.viewBoxBefore);
      const beforeBox = document.createElement('div');
      beforeBox.className = 'svg-box';
      beforeBox.innerHTML = `<strong>Before:</strong><br><code>viewBox="${test.viewBoxBefore}"</code>`;
      beforeBox.appendChild(svgBefore.cloneNode(true));

      // Sanitize
      const svgToTest = createSVG(test.viewBoxBefore);
      document.body.appendChild(svgToTest); // Must be in DOM
      const wasSanitized = SVGSanitizer.sanitizeSVGViewBox(svgToTest);
      const viewBoxAfter = svgToTest.getAttribute('viewBox');

      // Create after display
      const afterBox = document.createElement('div');
      afterBox.className = 'svg-box';
      afterBox.innerHTML = `<strong>After:</strong><br><code>viewBox="${viewBoxAfter}"</code>`;
      afterBox.appendChild(svgToTest);

      const container = document.createElement('div');
      container.className = 'svg-container';
      container.appendChild(beforeBox);
      container.appendChild(afterBox);
      testCase.appendChild(container);

      // Result
      const passed = viewBoxAfter === test.viewBoxExpected;
      const result = document.createElement('div');
      result.className = `result ${passed ? 'pass' : 'fail'}`;
      result.textContent = passed
        ? `‚úÖ PASS - ViewBox correctly ${wasSanitized ? 'sanitized' : 'preserved'}`
        : `‚ùå FAIL - Expected "${test.viewBoxExpected}", got "${viewBoxAfter}"`;
      testCase.appendChild(result);

      document.getElementById('testResults').appendChild(testCase);
      return passed;
    }

    function injectBadSVG() {
      const svg = createSVG('0 0 50% 50%');
      const container = document.createElement('div');
      container.className = 'test-case';
      container.innerHTML = '<h3>Dynamically Injected SVG</h3><p>Testing MutationObserver</p>';
      container.appendChild(svg);

      document.getElementById('testResults').appendChild(container);

      logToConsole('Injected SVG with viewBox="0 0 50% 50%"', 'info');

      // Check after a delay
      setTimeout(() => {
        const viewBox = svg.getAttribute('viewBox');
        const result = document.createElement('div');
        result.className = `result ${viewBox === '0 0 50 50' ? 'pass' : 'fail'}`;
        result.textContent = viewBox === '0 0 50 50'
          ? `‚úÖ MutationObserver caught and fixed: "${viewBox}"`
          : `‚ùå Not fixed: "${viewBox}"`;
        container.appendChild(result);
      }, 100);
    }

    function runAllTests() {
      document.getElementById('testResults').innerHTML = '';
      logToConsole('Starting test suite...', 'info');

      let passed = 0;
      let failed = 0;

      tests.forEach((test, index) => {
        const result = runTest(test, index);
        if (result) passed++;
        else failed++;
      });

      // Update summary
      const summary = document.getElementById('summary');
      const total = passed + failed;
      const percentage = ((passed / total) * 100).toFixed(1);

      summary.innerHTML = `
        <strong>Test Results:</strong><br>
        ‚úÖ Passed: ${passed}<br>
        ‚ùå Failed: ${failed}<br>
        üìä Success Rate: ${percentage}%<br>
        <strong>SVG Sanitizer Status:</strong> ${window.SVGSanitizer ? '‚úÖ Loaded' : '‚ùå Not Loaded'}
      `;

      logToConsole(`Test suite complete: ${passed}/${total} passed (${percentage}%)`, 'info');
    }

    // Check if SVGSanitizer loaded
    window.addEventListener('load', () => {
      logToConsole('Page loaded', 'info');
      logToConsole('SVGSanitizer: ' + (window.SVGSanitizer ? 'Available' : 'NOT FOUND'),
        window.SVGSanitizer ? 'info' : 'error');

      if (window.SVGSanitizer) {
        logToConsole('API Methods:', 'info');
        logToConsole('  - sanitizeSVGViewBox(svg)', 'info');
        logToConsole('  - sanitizeAllSVGs(root)', 'info');
        logToConsole('  - installSVGSanitizer(root)', 'info');
        logToConsole('  - initSVGSanitizer()', 'info');
      }

      // Auto-run tests
      setTimeout(runAllTests, 500);
    });

    // Monitor console for viewBox errors
    const originalError = window.onerror;
    window.onerror = function(message, source, lineno, colno, error) {
      if (message && message.toString().toLowerCase().includes('viewbox')) {
        logToConsole('‚ö†Ô∏è ViewBox error detected: ' + message, 'error');
      }
      if (originalError) {
        return originalError(message, source, lineno, colno, error);
      }
      return false;
    };
  </script>
</body>
</html>
