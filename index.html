<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Cardiology Suite</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#0f1419" />
  <meta name="apple-mobile-web-app-title" content="Cardiology Suite" />
  <meta name="application-name" content="Cardiology Suite" />
  <meta name="format-detection" content="telephone=no" />
  
  <!-- 
    ⚠️ CRITICAL: DO NOT MODIFY STYLESHEET ORDER OR REMOVE ANY CSS FILES ⚠️
    These stylesheets are loaded in a specific order for proper cascading.
    Each stylesheet serves a specific purpose and is required for the app to function.
    Last modified: 2025-10-22
  -->
  <link rel="stylesheet" href="styles/style.css" />
  <link rel="stylesheet" href="styles/dx-labs.css" />
  <link rel="stylesheet" href="styles/layout.css" />
  <link rel="stylesheet" href="styles/note-styles.css" />
  <link rel="stylesheet" href="styles/afib-enhanced.css" />
  <link rel="stylesheet" href="styles/meds.css" /><!-- Required for #/meds page -->
  <link rel="stylesheet" href="styles/guidelines.css" /><!-- Required for #/guidelines page -->
  <!-- END CRITICAL STYLESHEETS -->
  
  <link rel="manifest" href="manifest.json" />
  
  <!-- why: Codespaces/GitHub Dev tunnels block manifest with CORS; disable in that env -->
  <script>
    (function () {
      if (location.hostname.endsWith('.app.github.dev')) {
        const el = document.querySelector('link[rel="manifest"]');
        if (el) el.remove();
      }
    })();
  </script>
  
  <!-- Icons -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23dc2626' d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E" />
  
  <!-- SPA Entry - Single module script loads everything -->
  <script type="module" src="/src/core/app.js"></script>

  <script type="module">
    // why: ensure symbol exists before first use
    import * as TR from '/src/parsers/templateRenderer.js';
    window.templateRenderer = TR.templateRenderer || TR.default || TR;
  </script>

  <script defer>
    function whenDefined(getter, cb, timeoutMs = 4000, intervalMs = 50) {
      const t0 = performance.now();
      const id = setInterval(() => {
        const val = getter();
        if (val) { 
          clearInterval(id); 
          cb(val); 
        } else if (performance.now() - t0 > timeoutMs) { 
          clearInterval(id); 
          console.warn('templateRenderer still undefined after timeout'); 
        }
      }, intervalMs);
    }

    window.addEventListener('DOMContentLoaded', () => {
      whenDefined(() => window.templateRenderer || window.TemplateRendererInitialized, (val) => {
        console.log('✅ templateRenderer is ready');
        // Add manual test function for debugging
        window.testParseButton = () => {
          console.log('🧪 Manual test triggered');
          const text = document.getElementById('vs-paste').value;
          console.log('🧪 Text:', text.substring(0, 100));
          window.templateRenderer.processNote(text);
        };
        console.log('💡 Type testParseButton() in console to manually trigger parse');
      });
    });
  </script>
</head>
<body class="theme-dark">
  <div id="splash" aria-hidden="true"></div>

  <!-- Fixed Header -->
  <header id="banner">
    <div class="brand">Cardiology Suite</div>
    <nav class="header-nav">
      <a href="index.html" class="nav-tab active" data-page="main">
        <svg viewBox="0 0 24 24" width="16" height="16">
          <path fill="currentColor" d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
        </svg>
        Main
      </a>
            <a href="#/guidelines" class="nav-tab" data-page="guidelines">
        <svg viewBox="0 0 24 24" width="16" height="16">
          <path
            fill="currentColor"
            d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"
          />
        </svg>
        Guidelines & Teaching
      </a>
      <!-- Medications tab - only visible if feature flag enabled -->
      <a href="#/meds" class="nav-tab" data-page="meds" id="meds-nav-tab" style="display: none;">
        <svg viewBox="0 0 24 24" width="16" height="16">
          <path fill="currentColor" d="M10.5 13H8v-3h2.5V7.5h3V10H16v3h-2.5v2.5h-3V13zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
        </svg>
        Medications
      </a>
    </nav>
    <button class="theme-toggle" aria-label="Toggle theme">
      <svg class="theme-icon sun-icon" viewBox="0 0 24 24" width="24" height="24">
        <path d="M12 17a5 5 0 1 0 0-10 5 5 0 0 0 0 10zm0 2a7 7 0 1 1 0-14 7 7 0 0 1 0 14zm0-18a1 1 0 0 1 1 1v2a1 1 0 0 1-2 0V2a1 1 0 0 1 1-1zm0 18a1 1 0 0 1 1 1v2a1 1 0 0 1-2 0v-2a1 1 0 0 1 1-1z"/>
      </svg>
    </button>
  </header>

  <!-- Main Layout -->
  <div id="layout">
    <!-- Enhanced Left sidebar for diagnoses -->
    <aside id="dx-rail">
      <div class="dx-rail-header">
        <h3 class="dx-rail-title">
          <svg viewBox="0 0 24 24" width="20" height="20" class="title-icon">
            <path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
          </svg>
          Diagnoses
        </h3>
        <div class="search-container">
          <div class="search-input-wrapper">
            <svg class="search-icon" viewBox="0 0 24 24" width="16" height="16">
              <path fill="currentColor" d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
            </svg>
            <input type="text" id="search" placeholder="Search diagnoses..." aria-label="Search diagnoses" />
            <button class="search-clear hidden" aria-label="Clear search">×</button>
          </div>
          <div id="search-results" class="search-results"></div>
        </div>
      </div>
      <div class="dx-list">
        <!-- Diagnoses will be populated here -->
      </div>
    </aside>

    <!-- Main Content -->
    <!-- Main content area -->
    <main id="main">

      <!-- Clinical Note Input Section -->
      <section class="panel clinical-note-parser" id="clinical-note-input-panel">
        <div class="panel-h"><h3>📋 Clinical Note Parser</h3></div>
        <div class="clinical-note-input">
          <textarea id="vs-paste" rows="4" placeholder="Paste progress note, H&P, or clinical data here to parse vitals/labs and generate formatted note..." aria-label="Clinical note input"></textarea>
          <div class="flex mt-s">
            <button id="vs-parse" class="btn primary" aria-label="Parse clinical note and generate formatted output">🔄 Parse & Generate Note</button>
            <button id="vs-clear" class="btn ghost" aria-label="Clear all input and output fields">Clear All</button>
          </div>
        </div>
      </section>

      <div class="vitals-labs-grid">
        <!-- Vitals Panel -->
        <section class="panel">
          <div class="panel-h"><h3>Vitals</h3></div>
          <div class="grid cols-3">
            <label>SBP <input id="vs-sbp" inputmode="numeric" /></label>
            <label>DBP <input id="vs-dbp" inputmode="numeric" /></label>
            <label>HR <input id="vs-hr" inputmode="numeric" /></label>
            <label>RR <input id="vs-rr" inputmode="numeric" /></label>
            <label>Temp <input id="vs-temp" placeholder="98.6 F" /></label>
            <label>SpO₂ <input id="vs-spo2" inputmode="numeric" placeholder="%" /></label>
            <label>Height <input id="vs-height" placeholder="5'9&quot; or 175 cm" /></label>
            <label>Weight <input id="vs-weight" placeholder="lb or kg" /></label>
            <label>O₂ Device <input id="vs-o2dev" placeholder="RA" /></label>
          </div>
        </section>

        <!-- Labs Panel -->
        <section class="panel">
          <div class="panel-h"><h3>Key Labs</h3></div>
          <div class="labs-container">
            <table class="mini">
              <thead><tr><th>Lab</th><th>Value</th><th>Ref</th></tr></thead>
              <tbody id="tbl-labs"></tbody>
            </table>
          </div>
        </section>
      </div> <!-- end .vitals-labs-grid -->

      <!-- Diagnostic Reasoning Results -->
      <section class="panel" id="diagnostic-reasoning-panel" style="display: none;">
        <div class="panel-h"><h3>🔬 Diagnostic Reasoning Analysis</h3></div>
        <div class="diagnostic-content">
          <div class="grid cols-2">
            <div class="diagnostic-section">
              <h4>🎯 Differential Diagnosis</h4>
              <div id="differential-diagnosis" class="content"></div>
            </div>
            <div class="diagnostic-section">
              <h4>🔍 Recommended Workup</h4>
              <div id="recommended-workup" class="content"></div>
            </div>
          </div>
          <div class="diagnostic-section">
            <h4>💭 Clinical Reasoning</h4>
            <div id="clinical-reasoning" class="content"></div>
          </div>
        </div>
      </section>

      <!-- Template Renderer - Processed Note Display -->
      <section class="panel" id="template-renderer-panel">
        <div class="panel-h">
          <h3>📝 Template Renderer</h3>
          <div class="template-controls">
            <label class="template-select-label">
              Template:
              <select id="template-select" disabled>
                <option value="progress" selected>Progress Note (locked)</option>
              </select>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="smartphrase-toggle"> SmartPhrase
            </label>
          </div>
        </div>

        <div id="template-content" style="margin-bottom: 15px;">
          <textarea id="rendered-output" readonly
                    style="width: 100%; height: 400px; font-family: monospace; font-size: 0.9rem;
                           border: 3px solid lime; border-radius: 4px;
                           padding: 10px; background: #ffffff; color: #000000;
                           resize: vertical;"
                    placeholder="Processed note will appear here..."></textarea>
        </div>

        <div class="template-button-row">
          <button id="copy-output-btn" class="btn primary">
            📋 Copy (Ctrl+C)
          </button>
          <button id="download-output-btn" class="btn">
            💾 Download
          </button>
          <button id="clear-output-btn" class="btn ghost">
            🗑️ Clear
          </button>
        </div>

        <div id="renderer-status" style="margin-top: 10px; font-size: 0.9rem; color: var(--text-secondary);"></div>
      </section>

      <!-- Guidelines and Teaching -->
      <section class="panel" id="guidelines-teaching">
        <div class="panel-h"><h3>🎓 Guidelines & Teaching Points</h3></div>
        <div class="grid cols-2">
          <div id="acc-guidelines-out" class="guidelines-content">
            <h4>🏛️ ACC/AHA Guidelines</h4>
            <div class="content"></div>
          </div>
          <div id="teaching-insights-out" class="teaching-content">
            <h4>💡 Teaching Insights & Safety Alerts</h4>
            <div class="content">
              <div class="teaching-note">
                <span class="teaching-icon">💡</span>
                Complete the assessment above to see personalized teaching points, safety alerts, and documentation feedback for cardiology training.
              </div>
            </div>
          </div>
        </div>
      </section>

      <div id="dx-detail" class="panel mt"></div>
    </main>
  </div>

  <!-- Floating Action Button -->
  <div class="fab-container">
    <button class="fab-main" id="fab-main" title="Quick Actions">
      <svg class="fab-icon fab-icon-plus" viewBox="0 0 24 24" width="24" height="24">
        <path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
      </svg>
      <svg class="fab-icon fab-icon-close" viewBox="0 0 24 24" width="24" height="24" style="display: none;">
        <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
      </svg>
    </button>

    <div class="fab-actions" id="fab-actions">
      <button class="fab-action" data-action="parse-note" title="Parse Clinical Note">
        <svg viewBox="0 0 24 24" width="20" height="20">
          <path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
        </svg>
        <span class="fab-label">Parse Note</span>
      </button>

      <button class="fab-action" data-action="clear-all" title="Clear All Data">
        <svg viewBox="0 0 24 24" width="20" height="20">
          <path fill="currentColor" d="M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19M8,9H16V19H8V9M15.5,4L14.5,3H9.5L8.5,4H5V6H19V4H15.5Z"/>
        </svg>
        <span class="fab-label">Clear All</span>
      </button>

      <button class="fab-action" data-action="export-note" title="Export Generated Note">
        <svg viewBox="0 0 24 24" width="20" height="20">
          <path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12,19L8,15H10.5V12H13.5V15H16L12,19Z"/>
        </svg>
        <span class="fab-label">Export</span>
      </button>

      <button class="fab-action" data-action="quick-assess" title="Quick Assessment Mode">
        <svg viewBox="0 0 24 24" width="20" height="20">
          <path fill="currentColor" d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9Z"/>
        </svg>
        <span class="fab-label">Quick Assess</span>
      </button>
    </div>
  </div>

  <footer class="footer">
    <div class="footer-content">
      <p>Created by Martin Samson RN, BSN</p>
      <p>&copy; 2025 Cardiology Assistant. All rights reserved.</p>
    </div>
  </footer>

  <!-- Mobile Bottom Navigation -->
  <nav class="bottom-nav">
    <button class="nav-item active" data-section="vitals">
      <svg viewBox="0 0 24 24" width="24" height="24" preserveAspectRatio="xMidYMid meet">
        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
      </svg>
      <span>Vitals</span>
    </button>
    <button class="nav-item" data-section="labs">
      <svg viewBox="0 0 24 24" width="24" height="24" preserveAspectRatio="xMidYMid meet">
        <path d="M7 2v2h1v14c0 2.21 1.79 4 4 4s4-1.79 4-4V4h1V2H7zm5 14c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z"/>
      </svg>
      <span>Labs</span>
    </button>
    <button class="nav-item" data-section="meds">
      <svg viewBox="0 0 24 24" width="24" height="24" preserveAspectRatio="xMidYMid meet">
        <path d="M6 3h12v2H6V3zm11 3H7c-1.1 0-2 .9-2 2v11c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-1 9h-3v3h-2v-3H8v-2h3V8h2v3h3v2z"/>
      </svg>
      <span>Meds</span>
    </button>
    <button class="nav-item" data-section="plan">
      <svg viewBox="0 0 24 24" width="24" height="24" preserveAspectRatio="xMidYMid meet">
        <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
      </svg>
      <span>Plan</span>
    </button>
  </nav>
</body>
</html>